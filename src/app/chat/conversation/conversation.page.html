<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/chat/list"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ otherUserName || 'Chat' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="triggerCall()">
        <ion-icon slot="icon-only" name="call-outline" aria-label="Llamar"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content #chatContent class="ion-padding chat-content-background">
  <div *ngIf="isLoadingMessages" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando mensajes...</p>
  </div>

  <div class="message-list" *ngIf="!isLoadingMessages">
    <div *ngFor="let msg of messages" 
         class="message-wrapper"
         [ngClass]="{
           'message-sent': msg.senderId === currentUserId, 
           'message-received': msg.senderId !== currentUserId
         }">
      <div class="chat-bubble">
        <div class="message-text">
          <p *ngIf="msg.type === 'text'">{{ msg.text }}</p>
          <img *ngIf="msg.type === 'image' && msg.fileUrl" [src]="msg.fileUrl" alt="Imagen adjunta" style="max-width: 100%; border-radius: 10px; cursor: pointer;" (click)="openImage(msg.fileUrl)"/>
          <div *ngIf="msg.type === 'audio' && msg.fileUrl" class="audio-player-container">
            <audio controls [src]="msg.fileUrl" style="width: 100%;"></audio>
            </div>
          </div>
        <div class="message-timestamp">
          {{ msg.timestamp | date:'shortTime' }}
        </div>
      </div>
    </div>
  </div>
</ion-content>

<ion-footer class="chat-input-footer">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="selectAndSendImage()" fill="clear" color="medium" [disabled]="isRecording">
        <ion-icon slot="icon-only" name="images-outline" aria-label="Enviar imagen"></ion-icon>
      </ion-button>
      </ion-buttons>

    <ion-item lines="none" class="message-input-item">
      <ion-textarea
        autoGrow="true"
        rows="1"
        maxRows="4"
        placeholder="Escribe un mensaje..."
        [(ngModel)]="newMessageText"
        (keydown.enter)="sendMessageOnEnter($event)"
        [disabled]="isRecording"> </ion-textarea>
    </ion-item>

    <ion-buttons slot="end">
      <ion-button *ngIf="!isRecording && newMessageText.trim() !== ''" (click)="sendMessage()" [disabled]="!newMessageText || newMessageText.trim() === ''">
        <ion-icon slot="icon-only" name="send" aria-label="Enviar mensaje"></ion-icon>
      </ion-button>

      <ion-button *ngIf="!isRecording && newMessageText.trim() === ''" (click)="toggleRecording()" fill="clear" color="medium">
        <ion-icon slot="icon-only" name="mic-outline" aria-label="Grabar audio"></ion-icon>
      </ion-button>
      <ion-button *ngIf="isRecording" (click)="toggleRecording()" fill="clear" color="danger">
        <ion-icon slot="icon-only" name="stop-circle-outline" aria-label="Detener y enviar grabaciÃ³n"></ion-icon> 
      </ion-button>
      </ion-buttons>
  </ion-toolbar>
</ion-footer>